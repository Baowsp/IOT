<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Home Dashboard</title>
    <!-- <link rel="manifest" href="manifest.json"> -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    
    <style>
        /* S·ª≠a l·∫°i Font v√† h√†nh vi cu·ªôn */
        body { 
            font-family: 'Inter', sans-serif; 
            overscroll-behavior: none; /* Ch·∫∑n hi·ªáu ·ª©ng k√©o n·∫£y c·ªßa iOS */
        }
        
        /* ·∫®n thanh cu·ªôn nh∆∞ng v·∫´n cu·ªôn ƒë∆∞·ª£c */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* CSS cho n√∫t g·∫°t */
        .toggle-checkbox:checked { right: 0; border-color: #3b82f6; }
        .toggle-checkbox:checked + .toggle-label { background-color: #3b82f6; }
        .toggle-checkbox { right: 0; z-index: 10; }
        
        .disabled-switch {
            opacity: 0.5;
            pointer-events: none;
            filter: grayscale(100%);
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 h-screen w-screen overflow-hidden flex justify-center items-center">

    <div class="w-full max-w-md h-full bg-white dark:bg-gray-950 shadow-2xl sm:rounded-3xl overflow-hidden flex flex-col relative sm:h-[90vh]">

        <div class="flex-none p-5 pb-2 flex justify-between items-center z-10 bg-white dark:bg-gray-950">
            <div>
                <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Smart Home</h1>
                <p id="connection-status" class="text-sm text-red-500 font-medium">üî¥ M·∫•t k·∫øt n·ªëi Server</p>
            </div>
            <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center">
                <i data-lucide="home" class="text-blue-600 w-5 h-5"></i>
            </div>
        </div>

        <div id="main-content" class="flex-1 overflow-y-auto no-scrollbar p-5 space-y-6">

            <div id="tab-controls" class="tab-content space-y-6">
                
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-orange-50 dark:bg-gray-800 p-3 rounded-xl">
                        <div class="flex items-center space-x-2 mb-2"><i data-lucide="thermometer" class="w-4 h-4 text-orange-500"></i><span class="text-xs text-gray-500">Nhi·ªát ƒë·ªô</span></div>
                        <span id="sensor-temp" class="text-xl font-bold text-gray-800 dark:text-white">--¬∞C</span>
                    </div>
                    <div class="bg-blue-50 dark:bg-gray-800 p-3 rounded-xl">
                        <div class="flex items-center space-x-2 mb-2"><i data-lucide="droplets" class="w-4 h-4 text-blue-500"></i><span class="text-xs text-gray-500">ƒê·ªô ·∫©m</span></div>
                        <span id="sensor-hum" class="text-xl font-bold text-gray-800 dark:text-white">--%</span>
                    </div>
                    <div class="bg-red-50 dark:bg-gray-800 p-3 rounded-xl">
                        <div class="flex items-center space-x-2 mb-2"><i data-lucide="flame" class="w-4 h-4 text-red-500"></i><span class="text-xs text-gray-500">Gas</span></div>
                        <span id="sensor-gas" class="text-xl font-bold text-gray-800 dark:text-white">--</span>
                    </div>
                    <div class="bg-cyan-50 dark:bg-gray-800 p-3 rounded-xl">
                        <div class="flex items-center space-x-2 mb-2"><i data-lucide="cloud-rain" class="w-4 h-4 text-cyan-500"></i><span class="text-xs text-gray-500">M∆∞a</span></div>
                        <span id="sensor-rain" class="text-xl font-bold text-gray-800 dark:text-white">--</span>
                    </div>
                </div>

                <h2 class="text-lg font-semibold text-gray-900 dark:text-white">ƒêi·ªÅu khi·ªÉn Thi·∫øt b·ªã</h2>
                
                <div class="space-y-4 pb-4"> <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700" id="group-door">
                        <div class="flex items-center space-x-3 mb-4">
                            <div class="p-2 bg-green-100 rounded-lg"><i data-lucide="door-open" class="w-6 h-6 text-green-600"></i></div>
                            <span class="font-bold text-gray-900 dark:text-white text-lg">C·ª≠a Ch√≠nh</span>
                        </div>
                        <div class="flex justify-between items-center bg-gray-50 dark:bg-gray-700/50 p-3 rounded-lg">
                            <div class="flex flex-col items-center gap-1">
                                <span class="text-xs font-semibold text-blue-600 dark:text-blue-400">T·ª∞ ƒê·ªòNG</span>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" data-type="auto" data-key="autoDoor" class="sr-only peer" onchange="handleMode(this)">
                                    <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-600 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                            </div>
                            <div class="h-8 w-[1px] bg-gray-300 dark:bg-gray-600"></div>
                            <div class="flex flex-col items-center gap-1 manual-control">
                                <span class="text-xs font-semibold text-gray-500 dark:text-gray-400">TH·ª¶ C√îNG</span>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" data-type="manual" data-key="doorOpen" class="sr-only peer" onchange="handleDevice(this)">
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-600 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700" id="group-roof">
                        <div class="flex items-center space-x-3 mb-4">
                            <div class="p-2 bg-indigo-100 rounded-lg"><i data-lucide="umbrella" class="w-6 h-6 text-indigo-600"></i></div>
                            <span class="font-bold text-gray-900 dark:text-white text-lg">M√°i Che</span>
                        </div>
                        <div class="flex justify-between items-center bg-gray-50 dark:bg-gray-700/50 p-3 rounded-lg">
                            <div class="flex flex-col items-center gap-1">
                                <span class="text-xs font-semibold text-blue-600 dark:text-blue-400">T·ª∞ ƒê·ªòNG</span>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" data-type="auto" data-key="autoRoof" class="sr-only peer" onchange="handleMode(this)">
                                    <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-600 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                            </div>
                            <div class="h-8 w-[1px] bg-gray-300 dark:bg-gray-600"></div>
                            <div class="flex flex-col items-center gap-1 manual-control">
                                <span class="text-xs font-semibold text-gray-500 dark:text-gray-400">TH·ª¶ C√îNG</span>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" data-type="manual" data-key="roofOpen" class="sr-only peer" onchange="handleDevice(this)">
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-600 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700" id="group-pir">
                        <div class="flex items-center space-x-3 mb-4">
                            <div class="p-2 bg-yellow-100 rounded-lg"><i data-lucide="lightbulb" class="w-6 h-6 text-yellow-600"></i></div>
                            <span class="font-bold text-gray-900 dark:text-white text-lg">ƒê√®n C·∫£m Bi·∫øn</span>
                        </div>
                        <div class="flex justify-between items-center bg-gray-50 dark:bg-gray-700/50 p-3 rounded-lg">
                            <div class="flex flex-col items-center gap-1">
                                <span class="text-xs font-semibold text-blue-600 dark:text-blue-400">AUTO PIR</span>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" data-type="auto" data-key="autoPIR" class="sr-only peer" onchange="handleMode(this)">
                                    <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-600 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                            </div>
                            <div class="h-8 w-[1px] bg-gray-300 dark:bg-gray-600"></div>
                            <div class="flex flex-col items-center gap-1 manual-control">
                                <span class="text-xs font-semibold text-gray-500 dark:text-gray-400">TH·ª¶ C√îNG</span>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" data-type="manual" data-key="ledPIR" class="sr-only peer" onchange="handleDevice(this)">
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-600 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700" id="group-gas">
                        <div class="flex items-center space-x-3 mb-4">
                            <div class="p-2 bg-red-100 rounded-lg"><i data-lucide="bell" class="w-6 h-6 text-red-600"></i></div>
                            <span class="font-bold text-gray-900 dark:text-white text-lg">C√≤i B√°o Gas</span>
                        </div>
                        <div class="flex justify-between items-center bg-gray-50 dark:bg-gray-700/50 p-3 rounded-lg">
                            <div class="flex flex-col items-center gap-1">
                                <span class="text-xs font-semibold text-blue-600 dark:text-blue-400">AUTO GAS</span>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" data-type="auto" data-key="autoGasBuzzer" class="sr-only peer" onchange="handleMode(this)">
                                    <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-600 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                            </div>
                            <div class="h-8 w-[1px] bg-gray-300 dark:bg-gray-600"></div>
                            <div class="flex flex-col items-center gap-1 manual-control">
                                <span class="text-xs font-semibold text-gray-500 dark:text-gray-400">TH·ª¶ C√îNG</span>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" data-type="manual" data-key="gasBuzzer" class="sr-only peer" onchange="handleDevice(this)">
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-600 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div>
                                </label>
                            </div>
                        </div>
                    </div>
                     <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700" id="group-bedroom">
                        <div class="flex items-center space-x-3 mb-4">
                            <div class="p-2 bg-purple-100 rounded-lg"><i data-lucide="lamp" class="w-6 h-6 text-purple-600"></i></div>
                            <span class="font-bold text-gray-900 dark:text-white text-lg">ƒê√®n Ng·ªß</span>
                        </div>
                        <div class="flex justify-end items-center bg-gray-50 dark:bg-gray-700/50 p-3 rounded-lg">
                            <div class="flex flex-col items-center gap-1 manual-control">
                                <span class="text-xs font-semibold text-gray-500 dark:text-gray-400">TH·ª¶ C√îNG</span>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" data-type="manual" data-key="ledBedRoom" class="sr-only peer" onchange="handleDevice(this)">
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-600 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div>
                                </label>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <div id="tab-camera" class="tab-content hidden space-y-4">
                <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Camera AI</h1>
                <div class="bg-black rounded-xl overflow-hidden aspect-video flex justify-center items-center relative">
                    <div id="camera-placeholder" class="text-gray-500 flex flex-col items-center">
                        <i data-lucide="video-off" class="w-12 h-12 mb-2"></i>
                        <span id="cam-msg">ƒêang k·∫øt n·ªëi...</span>
                    </div>
                    <img id="camera-stream" class="hidden w-full h-full object-contain" src="" alt="Camera Stream" onerror="handleCamError()">
                    <button onclick="reloadCamera()" class="absolute top-2 right-2 bg-white/20 p-2 rounded-full hover:bg-white/40 backdrop-blur-sm">
                        <i data-lucide="refresh-cw" class="w-5 h-5 text-white"></i>
                    </button>
                </div>
                <div class="bg-red-50 dark:bg-red-900/20 p-4 rounded-xl flex justify-between items-center">
                    <span class="font-medium text-red-700 dark:text-red-400">C√≤i b√°o ƒë·ªông</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" data-type="manual" data-key="camBuzzer" class="sr-only peer" onchange="handleDevice(this)">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-600 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-red-600"></div>
                    </label>
                </div>
            </div>

            <div id="tab-settings" class="tab-content hidden">
                <h1 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">C·∫•u h√¨nh H·ªá th·ªëng</h1>
                <div class="space-y-6">
                    <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-xl">
                        <div class="flex items-center space-x-2 mb-3"><i data-lucide="server" class="text-blue-600"></i><h3 class="font-semibold text-gray-900 dark:text-white">Node.js Server</h3></div>
                        <input type="text" id="node-ip-input" placeholder="192.168.1.10" class="w-full px-4 py-3 rounded-lg border">
                    </div>
                    <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-xl">
                        <div class="flex items-center space-x-2 mb-3"><i data-lucide="cpu" class="text-purple-600"></i><h3 class="font-semibold text-gray-900 dark:text-white">AI Server</h3></div>
                        <input type="text" id="ai-ip-input" placeholder="192.168.1.20" class="w-full px-4 py-3 rounded-lg border">
                    </div>
                    <button id="save-config-btn" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold">L∆∞u & K·∫øt n·ªëi</button>
                    <p id="save-status" class="text-center text-sm font-medium min-h-[20px]"></p>
                </div>
            </div>

        </div>

        <div class="flex-none h-20 bg-white dark:bg-gray-950 border-t border-gray-100 dark:border-gray-800 flex justify-around items-center px-2 z-10">
            <button class="nav-btn p-3 rounded-xl transition-all" data-tab="controls" onclick="showTab('controls')"><i data-lucide="layout-dashboard" class="w-6 h-6"></i></button>
            <button class="nav-btn p-3 rounded-xl transition-all" data-tab="camera" onclick="showTab('camera')"><i data-lucide="video" class="w-6 h-6"></i></button>
            <button class="nav-btn p-3 rounded-xl transition-all" data-tab="settings" onclick="showTab('settings')"><i data-lucide="settings" class="w-6 h-6"></i></button>
        </div>
    </div>

    <script>
        // LOGIC JAVASCRIPT GI·ªÆ NGUY√äN NH∆Ø C≈®
        let socket;
        let nodeIp = localStorage.getItem('nodeIp') || '';
        let aiIp = localStorage.getItem('aiIp') || '';
        let aiSocket;
        const NODE_PORT = 3000;
        const AI_PORT = 5000;

        const DEVICE_MAP = {
            'doorOpen': 'autoDoor',
            'roofOpen': 'autoRoof',
            'ledPIR': 'autoPIR',
            'gasBuzzer': 'autoGasBuzzer'
        };

        function connectSocket() {
            if (!nodeIp) {
                document.getElementById('connection-status').innerText = '‚ö†Ô∏è Ch∆∞a c·∫•u h√¨nh IP';
                return;
            }
            if (socket) socket.disconnect();
            socket = io(`http://${nodeIp}:${NODE_PORT}`, { 
                transports: ['websocket'], // B·ªè qua polling, d√πng ngay WebSocket
                upgrade: false,            // T·∫Øt t√≠nh nƒÉng t·ª± n√¢ng c·∫•p (v√¨ ƒë√£ d√πng WS r·ªìi)
                reconnection: true,        // T·ª± ƒë·ªông k·∫øt n·ªëi l·∫°i n·∫øu m·∫•t m·∫°ng
                reconnectionAttempts: 5    // Th·ª≠ l·∫°i 5 l·∫ßn
            });
            socket.on('connect', () => {
                document.getElementById('connection-status').innerHTML = '<span class="text-green-500">üü¢ ƒê√£ k·∫øt n·ªëi</span>';
            });
            socket.on('disconnect', () => {
                document.getElementById('connection-status').innerHTML = '<span class="text-red-500">üî¥ M·∫•t k·∫øt n·ªëi</span>';
            });
            socket.on('state:sync', (data) => {
                updateSensorUI(data.sensors);
                updateAutoModesUI(data.autoModes);
                updateDevicesUI(data.devices, data.autoModes);
            });
            socket.on('devices:update', (devices) => {
                const currentAutoModes = getCurrentAutoStateFromDOM();
                updateDevicesUI(devices, currentAutoModes);
            });
            socket.on('mode:update', (autoModes) => {
                updateAutoModesUI(autoModes);
                lockManualButtons(autoModes);
            });
            socket.on('sensors:update', updateSensorUI);
        }

        function getCurrentAutoStateFromDOM() {
            const modes = {};
            document.querySelectorAll('input[data-type="auto"]').forEach(input => {
                modes[input.dataset.key] = input.checked;
            });
            return modes;
        }

        function updateSensorUI(sensors) {
            if (!sensors) return;
            document.getElementById('sensor-temp').innerText = (sensors.temperature || '--') + '¬∞C';
            document.getElementById('sensor-hum').innerText = (sensors.humidity || '--') + '%';
            document.getElementById('sensor-gas').innerText = sensors.gas || '--';
            document.getElementById('sensor-rain').innerText = sensors.rainValue || '--';
        }

        function updateAutoModesUI(autoModes) {
            if (!autoModes) return;
            for (const [key, value] of Object.entries(autoModes)) {
                const input = document.querySelector(`input[data-type="auto"][data-key="${key}"]`);
                if (input) input.checked = value;
            }
            lockManualButtons(autoModes);
        }

        function updateDevicesUI(devices, autoModes) {
            if (!devices) return;
            for (const [key, value] of Object.entries(devices)) {
                const input = document.querySelector(`input[data-type="manual"][data-key="${key}"]`);
                if (input) {
                    input.checked = value;
                    const autoKey = DEVICE_MAP[key];
                    if (autoKey && autoModes && autoModes[autoKey]) {
                        input.disabled = true;
                    } else {
                        input.disabled = false;
                    }
                }
            }
            if (autoModes) lockManualButtons(autoModes);
        }

        function lockManualButtons(autoModes) {
            for (const [deviceKey, autoKey] of Object.entries(DEVICE_MAP)) {
                const isAutoOn = autoModes[autoKey];
                const manualInput = document.querySelector(`input[data-type="manual"][data-key="${deviceKey}"]`);
                if (manualInput) {
                    const manualContainer = manualInput.closest('.manual-control');
                    if (isAutoOn) {
                        manualInput.disabled = true;
                        if (manualContainer) manualContainer.classList.add('disabled-switch');
                    } else {
                        manualInput.disabled = false;
                        if (manualContainer) manualContainer.classList.remove('disabled-switch');
                    }
                }
            }
        }

        function handleMode(element) {
            const moduleKey = element.dataset.key;
            const isAuto = element.checked;
            if (socket && socket.connected) {
                socket.emit('mode:change', { module: moduleKey, auto: isAuto });
            } else {
                alert("M·∫•t k·∫øt n·ªëi Server!");
                element.checked = !isAuto;
            }
        }

        function handleDevice(element) {
            if (element.disabled) return;
            const deviceKey = element.dataset.key;
            const value = element.checked;
            if (socket && socket.connected) {
                socket.emit('device:toggle', { device: deviceKey, value: value });
            } else {
                alert("M·∫•t k·∫øt n·ªëi Server!");
                element.checked = !value;
            }
        }

        function loadCameraStream() {
            if (!aiIp) return;

            // K·∫øt n·ªëi t·ªõi Python qua Socket.IO
            if (aiSocket) aiSocket.disconnect();
            
            aiSocket = io(`http://${aiIp}:${AI_PORT}`, {
                transports: ['websocket']
            });

            // L·∫Øng nghe s·ª± ki·ªán nh·∫≠n ·∫£nh
            aiSocket.on('cam_data', (base64Image) => {
                const imgEl = document.getElementById('camera-stream');
                // G√°n d·ªØ li·ªáu Base64 tr·ª±c ti·∫øp v√†o src
                imgEl.src = "data:image/jpeg;base64," + base64Image;
                
                imgEl.classList.remove('hidden');
                document.getElementById('camera-placeholder').classList.add('hidden');
            });
        }
        function handleCamError() {
            document.getElementById('camera-stream').classList.add('hidden');
            document.getElementById('camera-placeholder').classList.remove('hidden');
        }
        function reloadCamera() {
            if(aiIp) document.getElementById('camera-stream').src = `http://${aiIp}:${AI_PORT}/stream?t=${Date.now()}`;
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.toggle('text-blue-600', btn.dataset.tab === tabName);
                btn.classList.toggle('bg-blue-50', btn.dataset.tab === tabName);
                btn.classList.toggle('text-gray-500', btn.dataset.tab !== tabName);
            });
            if(window.lucide) lucide.createIcons();
            if(tabName === 'camera') loadCameraStream();
        }

        document.getElementById('save-config-btn').addEventListener('click', () => {
            const newNodeIp = document.getElementById('node-ip-input').value.trim();
            const newAiIp = document.getElementById('ai-ip-input').value.trim();
            if (newNodeIp && newAiIp) {
                nodeIp = newNodeIp; aiIp = newAiIp;
                localStorage.setItem('nodeIp', nodeIp); localStorage.setItem('aiIp', aiIp);
                alert("ƒê√£ l∆∞u");
                connectSocket();
                setTimeout(() => showTab('controls'), 1000);
            }
        });

        window.addEventListener('load', () => {
            lucide.createIcons();
            document.getElementById('node-ip-input').value = nodeIp;
            document.getElementById('ai-ip-input').value = aiIp;
            if(!nodeIp) showTab('settings');
            else { showTab('controls'); connectSocket(); }
        });
        // if ('serviceWorker' in navigator) {
        // window.addEventListener('load', () => {
        //     navigator.serviceWorker.register('/sw.js')
        //     .then(reg => console.log('Service Worker registered', reg))
        //     .catch(err => console.error('SW registration failed', err));
        // });
        // }
    </script>
</body>
</html>